<template>
	<div>
		<el-col :span="24" class="toolbar t-search float-r">
			<el-form :inline="true" :model="data.query" class="flex">
				<div class="flex1">
					<el-form-item v-for="v in searchFields" :label="v.label">
						<el-input :placeholder="v.placeholder ? v.placeholder : '请输入'+v.label"  v-model="data.query[v.prop]" v-if="!v.type || v.type == 'text'"></el-input>
						<el-select v-model="data.query[v.prop]" placeholder="请选择" v-if="v.type == 'select'">
							<el-option  :label="q.label" :value="q.value" v-for="q in data[v.datakey]" v-if="v.datakey"></el-option>
							<el-option  :label="q.label" :value="q.value" v-for="q in v.data" v-if="v.data"></el-option>
						</el-select>
						<div v-if="v.type == 'betweenDate'">
							<el-date-picker type="date" :placeholder="v.placeholder ? v.placeholder :'选择'+v.label+'开始范围' " v-model="data.query[v.prop+'_start'] " value-format="yyyy-MM-dd"> </el-date-picker>~
							<el-date-picker type="date" :placeholder="v.placeholder ? v.placeholder :'选择'+v.label+'结束范围'" v-model="data.query[v.prop+'_end'] " value-format="yyyy-MM-dd"> </el-date-picker>
						</div>
						<!-- <el-date-picker type="daterange" :placeholder="'选择'+v.label+'范围'" v-model="data.query[v.prop]" v-if="v.type == 'betweenDate'"> </el-date-picker> -->
						<el-button-group v-if="v.type == 'searchYear'">
							<el-button :type="data.query[v.prop] == year.prop ? 'primary' : '' " v-for="year in v.children" @click="data.query[v.prop]  = year.prop;search();">{{year.label}}</el-button>
						</el-button-group>
					</el-form-item>
					<el-form-item>
						<el-button type="primary" @click="search" v-if="searchFields">查询</el-button>
						<el-button type="primary" @click="$refs.category.ajax()" v-if="classAction">类别管理</el-button>
						<el-button type="success" @click="exportExcel" v-if="exportUrl">导出</el-button>
						<el-button type="success"  v-if="uploadData && uploadData.url" @click="upload">上传</el-button>
					</el-form-item>
					<el-form-item style="slot">
						<slot name="header"/>
					</el-form-item>
				</div>
				<div class="Hright">
					<el-form-item style="slot">
						<slot name="headerR"/>
					</el-form-item>
					<el-form-item class="mr0">
						<el-button type="primary" @click.native="$refs.createEdit.ajax('',data,fields)" v-if="canCreate">新建{{tableName =="users" ? '会员' :''}}</el-button>
					</el-form-item>
				</div>
			</el-form>
		</el-col>
		<slot name="header2"/>
		<el-col :span="24" v-if="tarbars">
			<el-tabs v-model="data.query[tarbars.prop]" type="card" @tab-click="tabClick">
				<el-tab-pane :label="v.count ? v.label+ '('+data[v.datakey]+')':v.label" :name="''+v.value" v-for="v in tarbars.data"></el-tab-pane>
			</el-tabs>
		</el-col>
		<el-table ref="multipleTable" :data="data.lists" border tooltip-effect="dark" style="width: 100%"
			@selection-change="selsChange" v-loading="data.listLoading">
			<el-table-column type="selection" width="50" v-if="checkAll"> </el-table-column>
            <div v-for="(v,key) in tableFields" v-show="v['hidden_'+v.prop]? canShow(v):true">
                <el-table-column  :prop="v.prop"  :label="v.label" :width="v.width" :align="v.align ? v.align:'left'" :min-width="v.minWidth" v-if="!v.hidden">
                       <template scope="scope" v-if="v.type || !v.type && v['append_table_'+v.prop]">
                             <div v-if="v.type && v.type == 'editField'">
                                 <el-switch v-model="scope.row[v.prop]" on-text="" off-text="" :active-value="1" :inactive-value="0" @change="editField(scope.row,v.prop,v.url)"> </el-switch>
                             </div>
                             <div v-if="v.type && v.type == 'sort'">
                                <el-input v-model="scope.row[v.prop]"  @change="editField(scope.row,v.prop,v.url)"></el-input>
                             </div>
                            <slot :name="'append_table_'+v.prop" :row="scope.row" :$index='scope.$index'  v-if="!v.type && v['append_table_'+v.prop]"/>
                       </template>
                </el-table-column>
            </div>
			<el-table-column label="操作" :width="operateWidth ? operateWidth : '160'">
				<template scope="scope">
                    <div v-if="tableOperateButton">
                        <el-dropdown>
                        	<el-button type="primary" size="mini">操作<i class="el-icon-arrow-down el-icon--right"></i></el-button>
                        	<el-dropdown-menu slot="dropdown">
                        		<el-dropdown-item @click.native="$refs.createEdit.ajax(scope.row,data,fields)"  v-if="canEdit">编辑</el-dropdown-item>
                        		<el-dropdown-item @click.native="refs.createEdit.ajax(scope.row,data,fields,'info')"  v-if="showInfo">查看</el-dropdown-item>
                        		<el-dropdown-item @click.native="changeStatus(scope.$index, scope.row,'1')"  v-if="scope.row.status!=1 && auditAction">审核通过</el-dropdown-item>
                        		<el-dropdown-item @click.native="changeStatus(scope.$index, scope.row,'2')"  v-if="scope.row.status!=2 && auditAction">审核拒绝</el-dropdown-item>
                                <slot name="operate" :row="scope.row"></slot>
                        		<el-dropdown-item @click.native="handleDel(scope.$index,scope.row)"  v-if="canDel">删除</el-dropdown-item>

                        	</el-dropdown-menu>
                        </el-dropdown>
                    </div>
                    <div class="cell_group" v-else>
                        <el-button type="primary" size="mini" @click.native="$refs.createEdit.ajax(scope.row,data,fields)" v-if="canEdit">编辑</el-button>
                        <el-button type="primary" size="mini" @click.native="$refs.createEdit.ajax(scope.row,data,fields,'info')" v-if="showInfo">查看</el-button>
                        <el-button type="primary" size="mini" @click="changeStatus(scope.$index, scope.row,'1')" v-if="scope.row.status==0 && auditAction">审核通过</el-button>
                        <el-button type="primary" size="mini" @click="changeStatus(scope.$index, scope.row,'2')" v-if="scope.row.status== 0&& auditAction">审核拒绝</el-button>
                        <div class="slot_btn"><slot name="operate" :row="scope.row"></slot></div>
                        <el-button class="canDel" size="mini" @click.native="handleDel(scope.$index,scope.row)" v-if="canDel">删除</el-button>
                    </div>


				</template>
			</el-table-column>
		</el-table>
		<div class="toolbar foot-tool">
			<el-button type="danger" @click="delAll" :disabled="this.sels.length===0 " v-if="checkAll">批量删除</el-button>
			<el-button type="danger" @click="puawayAll(1)" :disabled="this.sels.length===0 " v-if="putaway">批量上架</el-button>
			<el-button type="danger" @click="puawayAll(0)" :disabled="this.sels.length===0 " v-if="putaway">批量下架</el-button>
			<slot name="tableLeft" :row="sels" />
			<el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="data.thisPage"
				:page-sizes="[pageSize]" :page-size="pageSize" layout="total, sizes, prev, pager, next, jumper" :total="data.total">
			</el-pagination>
		</div>
		<my-create-edit @createBeforeCallBack="createBeforeCallBack" @submitBeforeCallBack="submitBeforeCallBack" ref="createEdit" :fields="formFields" :data="data" :createAction="createAction" :editAction="editAction" :createEditLabel="createEditLabel" :createEditDiagWidth="createEditDiagWidth">
			  <div slot="content" slot-scope="scope">
				   <slot :name="scope.field" :row="scope.row"/>
			  </div>
		</my-create-edit>
		<my-status ref="status" style="width:100%" :formAction="auditAction" v-if="auditAction"/>
        <uploadFile :action="uploadUrl()" ref="upload" :downLoadUrl="uploadData.downloadUrl" v-if="uploadData && uploadData.url"></uploadFile>
		<my-class top="2%" ref="category" :online="online" :type="classType" :formAction="classAction" :sizearr="300" v-if="classAction" :canupload="canupload" :pageUrl="classUrl"></my-class>
	</div>
</template>
<script>
	export default {
		props: ["data",'globalData','operateWidth'],
		data(){
			return {
				sels: [], //列表选中列,
				fields:'',
				tableFields:[],
				putaway:false,
				searchFields:[],
				formFields:[],
				checkAll:'',
				createAction:'',
				delAction:'',
				delAllAction:'',
				editAction:'',
				auditAction:'',
				classAction:'',
				pageSize:15,
				tableName: '',
				canCreate:false,
				canEdit:false,
				showInfo:false,
				tarbars:{},
				classType:0,
				online:1,
				exportUrl:'',
				canupload:true,
				canDel:true,
				classUrl:'',
				siteName: this.getSiteName(),
				createEditLabel:"100px",
				createEditDiagWidth:"800px",
                tableOperateButton:false,
                uploadData:{}
			}
		},
		mounted(){
		   this.tableFields =  this.globalData.data.tableFields;
		   this.searchFields =  this.globalData.data.searchFields;
		   this.formFields =  this.globalData.data.formFields;
		   this.checkAll =  this.globalData.data.checkAll;

		   this.createAction =  this.globalData.data.createAction;
		   this.editAction =  this.globalData.data.editAction;
		   this.auditAction =  this.globalData.data.auditAction;
		   this.tableName =  this.globalData.data.tableName;
		   this.pageSize =  parseInt(this.globalData.data.pageSize);
		   this.canCreate =  this.globalData.data.canCreate;
		   this.canEdit =  this.globalData.data.canEdit;
		   this.tarbars =  this.globalData.data.tarbars;
		   this.classAction = this.globalData.data.classAction;
		   this.classType = this.globalData.data.classType;
		   this.online = this.globalData.data.online;
		   this.delAction = this.globalData.data.delAction;
		   this.delAllAction = this.globalData.data.delAllAction;
		   this.showInfo = this.globalData.data.showInfo;
		   this.putaway = this.globalData.data.putaway;
		   this.exportUrl = this.globalData.data.exportUrl;
           if(this.globalData.data.tableOperateButton !=undefined){
           		this.tableOperateButton = this.globalData.data.tableOperateButton;

           }
           if(this.globalData.data.uploadData !=undefined){
           		this.uploadData = this.globalData.data.uploadData;

           }
		   if(this.globalData.data.createEditLabel !=undefined){
				this.createEditLabel = this.globalData.data.createEditLabel;
		   }
		   if(this.globalData.data.canDel !=undefined){
				this.canDel = this.globalData.data.canDel;
		   }

		  if(this.globalData.data.createEditDiagWidth !=undefined){
			  this.createEditDiagWidth = this.globalData.data.createEditDiagWidth;
		  }

		   if(this.globalData.data.canupload !=undefined){
				 this.canupload = this.globalData.data.canupload;
			}
			if(this.globalData.data.classUrl !=undefined){
				  this.classUrl = this.globalData.data.classUrl;
			 }


		   console.log(this.tarbars);
		},
		methods: {
            upload(){
               this.$refs.upload.ajax();
            },
            canShow(v){
                return this.$emit("hidden_"+v.prop,v);

            },
			editField(row,field,url){
				this.postAjax(url, { id:row.id,field:field,value:row[field] }, msg => {
					if (msg.data.status == 3) {
						row[field] =0;
					}
					if (msg.data.status == 2) {
						this.ajax();
					}
				});
			},
            uploadUrl(){
              return this.urlApendOpenid(this.siteName + this.uploadData.url);
            },
			exportExcel() {
				let url = this.urlApendOpenid(this.exportUrl, this);
				let field = [];
				this.tableFields.forEach(msg=>{
					field.push(
						{label:msg.label,
						 prop:msg.prop}
					);
				});
				field = JSON.stringify(field);
				url+="&field="+field;
				window.open(this.siteName+url);
			},
			puawayAll(putaway){
				this.postAjax(this.putaway,{data:this.sels,putaway:putaway}).then(msg=>{
					if(msg.data.status == 2){
						this.ajax();
					}
				});
			},
            tabClick(){
                if(this.$parent.ajax){
                     this.$parent.ajax();
                }else{
                    this.$parent.$parent.$parent.ajax();
                }
            },
			search(){
			   this.data.nextPage=1;
               if(this.$parent.ajax){
                    this.$parent.ajax();
               }else{
                   this.$parent.$parent.$parent.ajax();
               }

			},
			createBeforeCallBack(row){
				  this.$emit("createBeforeCallBack",row);
			},
			submitBeforeCallBack(row){
				this.$emit("submitBeforeCallBack",row);
			},
			ajax(){
                 if(this.$parent.ajax){
                      this.$parent.ajax();
                 }else{
                     this.$parent.$parent.$parent.ajax();
                 }
			},
			selsChange: function(sels) {
				this.sels = sels;
			},
			handleSizeChange(val) {
				this.data.nextPage = val;
				this.ajax();
			},
			handleCurrentChange(val) {
				this.data.nextPage = val;
				this.ajax();
			},
			handleDel(index, item) {
				let delAction = this.delAction ? this.delAction : '';
				this.del_vuex(item, index, this,delAction)
			},
			delAll() { /*批量删除*/
				let delAllAction = this.delAllAction ? this.delAllAction : '';
				this.deleteAll(this,delAllAction);
			},
			changeStatus(index, item, status) {
				this.$refs.status.ajax({
					id: item.id,
					status: status
				});
			},
		},
		components: {
			'my-create-edit': resolve => require(['./create_edit'], resolve),
			'my-status': resolve => require(['./status.vue'], resolve),
			"my-class": resolve => require(['xiaozhu/vue/components/admin/class.vue'], resolve),
			"uploadFile": resolve => require(['xiaozhu/vue/components/admin/uploadFile.vue'], resolve),
		}
	}
</script>
<style>
.el-table td:last-child .cell{display: flex!important;}
.Hright .el-form-item:last-child{margin-right: 0;}
.slot_btn>div{display: flex;margin-left: 10px;}
.slot_btn .el-dropdown{margin-left: 10px;}
.slot_btn .el-dropdown:first-child{margin-left: 0;}
.canDel{margin-left: 10px;}
.cell .slot_btn:first-child>div{margin-left: 0;}
.cell .canDel:first-child{margin-left: 0;}
.cell .cell_group{display: flex;}
</style>
